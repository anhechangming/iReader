# Ireader

## 技术栈

后端：Spring boot

前端：Vue 3 + Vite

数据库：mysql

开发工具：IntelliJ IDEA、VS Code、Navicat Premium 17

接口测试：Apifox

## 项目结构

```
# ireader-backend 项目结构
ireader-backend
├── .idea
├── .mvn
├── books
├── ireader
├── src
│   ├── main
│   │   ├── java
│   │   │   └── com.library.ireaderbackend
│   │   │       ├── configuration
│   │   │       │   ├── CorsConfig  #跨域配置
│   │   │       │   └── WebMvcConfig #用户上传书放置位置
│   │   │       ├── controller
│   │   │       │   ├── AnnotationController #笔记
│   │   │       │   ├── BookController  # 书城
│   │   │       │   ├── BookShelfController #书架
│   │   │       │   ├── TestController
│   │   │       │   └── UserController #用户
│   │   │       ├── dto
│   │   │       │   └── UserRegisterDto
│   │   │       ├── entity
│   │   │       │   ├── Annotation
│   │   │       │   ├── Book
│   │   │       │   ├── BookContent
│   │   │       │   ├── LoginResponse
│   │   │       │   ├── User
│   │   │       │   └── UserBookShelf
│   │   │       ├── mapper
│   │   │       │   ├── AnnotationMapper
│   │   │       │   ├── BookContentMapper
│   │   │       │   ├── BookMapper
│   │   │       │   ├── UserBookShelfMapper
│   │   │       │   └── UserMapper
│   │   │       ├── Response
│   │   │       │   └── Result
│   │   │       ├── service
│   │   │       │   ├── AnnotationService
│   │   │       │   ├── BookContentService
│   │   │       │   ├── BookService
│   │   │       │   ├── UserBookShelfService
│   │   │       │   └── UserService
│   │   │       ├── Utils
│   │   │       │   ├── EpubParser #Epub格式解析
│   │   │       │   ├── JwtUtils  
│   │   │       │   ├── PdfParser #pdf格式解析
│   │   │       │   └── TxtParser #txt格式解析
│   │   │       └── IreaderBackendApplication  #启动类
│   │   └── resources
│   │       ├── books  # 书城两本测试书
│   │       │   ├── 一句顶一万句 - 刘震云.epub  
│   │       │   └── 给青年的十二封信.epub
│   │       ├── mapper
│   │       │   ├── AnnotationMapper.xml
│   │       │   ├── BookContentMapper.xml
│   │       │   └── BookMapper.xml
│   │       ├── static
│   │       ├── templates
│   │       └── application.yml
│   └── test
├── target
├── uploads
├── .gitattributes
├── .gitignore
├── HELP.md
├── mvnw
└── mvnw.cmd

```

````
```markdown
# IREADER-FRONTEND 项目结构

```
IREADER-FRONTEND
├── .vscode
├── node_modules
├── public
│   └── vite.svg
├── src
│   ├── assets
│   │   └── vue.svg
│   ├── components
│   ├── router
│   │   └── index.js
│   ├── views
│   │   ├── Bookshelf.vue  # 书架
│   │   ├── Home.vue #书城
│   │   ├── LoginRegister.vue #登录注册
│   │   └── Reader.vue #阅读
│   ├── App.vue
│   ├── main.js
│   └── style.css
├── .gitignore
├── index.html
├── package-lock.json
├── package.json
├── README.md
└── vite.config.js
```
```
````

## 后端接口

### 一、接口概览

本项目后端接口采用 RESTful 风格设计，基于 Spring Boot 实现，主要包含以下模块：

- 批注管理接口（`/api/annotations`）
- 书籍管理接口（`/api/book`）
- 书架管理接口（`/api/bookshelf`）
- 用户管理接口（`/api/user`）

所有接口返回格式统一为 JSON，成功响应包含业务数据，错误响应包含错误信息。

### 二、批注管理接口（`/api/annotations`）

### 1. 新增批注

- **接口地址**：`POST /api/annotations/add`
- **功能描述**：添加用户对书籍的批注
- **请求体（Request Body）**：

```json
{
  "userId": 123,         // 用户ID（必填）
  "bookId": 456,         // 书籍ID（必填）
  "bookContentId": 789,  // 章节ID（必填）
  "content": "这段写得很好",  // 批注内容（必填）
  "position": "10-20",   // 批注在章节中的位置（可选）
  "createTime": "2023-10-06T12:00:00"  // 创建时间（可选，后端可自动生成）
}
```

- **响应示例**：

```json
{
  "success": true,
  "id": 1001  // 新增批注的ID
}
```



### 2. 查询某本书的所有批注

- **接口地址**：`GET /api/annotations/book/{bookId}`

- **功能描述**：获取指定用户对某本书的所有批注

- **路径参数**：`bookId` - 书籍 ID

- **请求参数（Query）**：`userId` - 用户 ID（必填）

- **响应示例**：

  ```json
  [
    {
      "id": 1001,
      "userId": 123,
      "bookId": 456,
      "bookContentId": 789,
      "content": "这段写得很好",
      "position": "10-20",
      "createTime": "2023-10-06T12:00:00"
    },
    {
      "id": 1002,
      "userId": 123,
      "bookId": 456,
      "bookContentId": 790,
      "content": "此处有疑问",
      "position": "5-15",
      "createTime": "2023-10-06T14:30:00"
    }
  ]
  ```

  

### 3. 查询某章节的批注

- **接口地址**：`GET /api/annotations/chapter/{bookContentId}`

- **功能描述**：获取指定用户对某章节的所有批注

- **路径参数**：`bookContentId` - 章节 ID

- **请求参数（Query）**：`userId` - 用户 ID（必填）

- **响应示例**:

  ```json
  [
    {
      "id": 1001,
      "userId": 123,
      "bookId": 456,
      "bookContentId": 789,
      "content": "这段写得很好",
      "position": "10-20",
      "createTime": "2023-10-06T12:00:00"
    }
  ]
  ```

  

### 4. 删除批注

- **接口地址**：`DELETE /api/annotations/{id}`

- **功能描述**：删除指定 ID 的批注

- **路径参数**：`id` - 批注 ID

- **响应示例**:

  ```json
  {
    "success": true,
    "message": "删除成功"
  }
  ```

  

### 5. 更新批注

- **接口地址**：`PUT /api/annotations/{id}`

- **功能描述**：更新指定 ID 的批注内容

- **路径参数**：`id` - 批注 ID

- **请求体（Request Body）**:

  ```json
  {
    "content": "更新后的批注内容",  // 新的批注内容（必填）
    "position": "15-25"  // 可选，更新位置信息
  }
  ```

  

- **响应示例**:

  ```json
  {
    "success": true,
    "message": "更新成功"
  }
  ```

  

### 三、书籍管理接口（`/api/book`）

### 1. 获取书籍列表

- **接口地址**：`GET /api/book/list`

- **功能描述**：根据关键词或分类查询书籍列表

- 请求参数（Query）：

  - `keyword`：搜索关键词（可选，匹配书名或作者）
  - `category`：书籍分类（可选）

- **响应示例**:

  ```json
  [
    {
      "id": 456,
      "title": "给青年的十二封信",
      "author": "朱光潜",
      "cover": "/static/covers/456.jpg",
      "category": "散文",
      "intro": "本书是朱光潜先生写给青年的十二封信..."
    },
    {
      "id": 457,
      "title": "一句顶一万句",
      "author": "刘震云",
      "cover": "/static/covers/457.jpg",
      "category": "小说",
      "intro": "本书讲述了普通人的命运与情感..."
    }
  ]
  ```

  

### 2. 获取书籍详情

- **接口地址**：`GET /api/book/detail/{id}`

- **功能描述**：获取指定书籍的详细信息

- **路径参数**：`id` - 书籍 ID

- **响应示例**:

  ```json
  {
    "id": 456,
    "title": "给青年的十二封信",
    "author": "朱光潜",
    "cover": "/static/covers/456.jpg",
    "category": "散文",
    "intro": "本书是朱光潜先生写给青年的十二封信...",
    "publisher": "中华书局",
    "publishTime": "2018-01-01",
    "isbn": "9787101128319",
    "fileType": "epub",
    "isFree": 1  // 1-免费，0-付费
  }
  ```

  

### 3. 获取书籍章节列表

- **接口地址**：`GET /api/book/content/{bookId}`

- **功能描述**：获取指定书籍的章节列表（若数据库中无章节数据，则自动解析书籍文件并写入数据库）

- **路径参数**：`bookId` - 书籍 ID

- **响应示例**:

  ```json
  [
    {
      "id": 789,
      "bookId": 456,
      "title": "第一封信：谈读书",
      "order": 1  // 章节顺序
    },
    {
      "id": 790,
      "bookId": 456,
      "title": "第二封信：谈动",
      "order": 2
    }
  ]
  ```

  

### 4. 获取章节内容

- **接口地址**：`GET /api/book/content/{bookId}/chapter/{order}`

- **功能描述**：获取指定书籍中指定顺序的章节内容（返回 HTML 格式）

- **路径参数**：

  - `bookId` - 书籍 ID
  - `order` - 章节顺序（从 1 开始）

- **响应示例**:

  ```json
  {
    "id": 789,
    "bookId": 456,
    "title": "第一封信：谈读书",
    "order": 1,
    "content": "<p>朋友：中学课程很多，你自然没有许多时间去读课外书...</p>"  // HTML格式的章节内容
  }
  ```

  

### 四、书架管理接口（`/api/bookshelf`）

### 1. 获取用户书架列表

- **接口地址**：`GET /api/bookshelf/list`

- **功能描述**：获取指定用户的书架书籍列表（支持关键词搜索）

- 请求参数（Query）：

  - `userId`：用户 ID（必填）
  - `keyword`：搜索关键词（可选，匹配书名或作者）

- 响应示例:

  ```json
  [
    {
      "id": 456,
      "title": "给青年的十二封信",
      "author": "朱光潜",
      "cover": "/static/covers/456.jpg",
      "category": "散文"
    },
    {
      "id": 457,
      "title": "一句顶一万句",
      "author": "刘震云",
      "cover": "/static/covers/457.jpg",
      "category": "小说"
    }
  ]
  ```

  

### 2. 添加书籍到书架

- **接口地址**：`POST /api/bookshelf/add`
- **功能描述**：将指定书籍添加到用户书架（若已存在则返回冲突）
- 请求参数（Query）：
  - `userId`：用户 ID（必填）
  - `bookId`：书籍 ID（必填）
- 响应示例：
  - 成功：`"添加成功"`
  - 已存在：`"该书已在您的书架中"`（HTTP 状态码 409）
  - 参数错误：`"userId 或 bookId 不能为空"`（HTTP 状态码 400）

### 3. 从书架移除书籍

- **接口地址**：`DELETE /api/bookshelf/remove`
- **功能描述**：将指定书籍从用户书架中移除
- 请求参数（Query)：
  - `userId`：用户 ID（必填）
  - `bookId`：书籍 ID（必填）
- **响应示例**：`"移除成功"`

### 4. 上传并解析书籍

- **接口地址**：`POST /api/bookshelf/uploadAndParse`

- **功能描述**：上传书籍文件（支持 txt/epub/pdf），解析为章节并自动添加到用户书架

- 请求参数

  ：

  - `file`：书籍文件（FormData 格式，必填）
  - `userId`：用户 ID（FormData 参数，必填）

- 响应示例

  ：

  - 成功：`"上传并解析成功"`
  - 格式错误：`"仅支持 txt / epub / pdf"`（HTTP 状态码 400）
  - 服务器错误：`"上传解析出错：[错误信息]"`（HTTP 状态码 500）

### 五、用户管理接口（`/api/user`）

### 1. 用户注册

- **接口地址**：`POST /api/user/register`

- **功能描述**：用户注册（通过手机号和密码）

- 请求体（Request Body）:

  ```json
  {
    "phone": "13800138000",  // 手机号（必填）
    "password": "123456"     // 密码（必填）
  }
  ```

  

- 响应示例:

  

  ```json
  {
    "code": 200,
    "msg": "注册成功",
    "data": {
      "userId": 123,
      "phone": "13800138000"
    }
  }
  ```

  

### 2. 用户登录

- **接口地址**：`POST /api/user/login`

- **功能描述**：用户登录（通过手机号和密码），成功后返回 JWT 令牌

- 请求体（Request Body）:

  ```json
  {
    "phone": "13800138000",  // 手机号（必填）
    "password": "123456"     // 密码（必填）
  }
  ```

  

- 响应示例:

  ```json
  {
    "code": 200,
    "msg": "登录成功",
    "data": {
      "userId": 123,
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."  // JWT令牌
    }
  }
  ```

  

### 3. 获取当前用户信息

- **接口地址**：`GET /api/user/info`

- **功能描述**：获取当前登录用户的信息（需在请求头携带 JWT 令牌）

- **请求头**：`Authorization: Bearer [token]`（token 为登录接口返回的令牌）

- 响应示例:

  ```json
  {
    "code": 200,
    "msg": "success",
    "data": {
      "userId": 123,
      "phone": "13800138000",
      "nickname": "默认昵称",
      "avatar": "/static/avatars/default.png"
    }
  }
  ```

  

- **错误响应**：`{"code": 401, "msg": "未登录或令牌失效", "data": null}`

### 六、通用说明

1. **令牌验证**：所有需要登录的接口（如获取用户信息、操作书架、添加批注等）需在请求头携带 `Authorization: Bearer [token]`，其中 `token` 为登录接口返回的 JWT 令牌。
2. **响应格式**：
   - 成功响应：`{"code": 200, "msg": "success", "data": [业务数据]}`（部分接口直接返回业务数据，如书籍列表、批注列表）
   - 错误响应：`{"code": [错误码], "msg": "[错误信息]", "data": null}`
3. **文件格式**：支持上传的书籍格式为 `txt`、`epub`、`pdf`，其他格式会被拒绝。
4. **事务说明**：书籍上传与解析接口（`uploadAndParse`）使用事务管理，确保书籍信息、章节数据、书架关联的原子性



## 数据库

### annotation.json（注释表）

| 字段名          | 类型   | 描述                                        |
| --------------- | ------ | ------------------------------------------- |
| id              | 整数   | 注释唯一标识                                |
| user_id         | 整数   | 关联的用户 ID                               |
| book_id         | 整数   | 关联的书籍 ID                               |
| book_content_id | 整数   | 书籍内容 ID                                 |
| chapter_order   | 整数   | 章节序号                                    |
| type            | 字符串 | 注释类型（BOOKMARK：书签，HIGHLIGHT：高亮） |
| text_content    | 字符串 | 高亮的文本内容（书签为 null）               |
| color           | 字符串 | 高亮颜色（书签为 null）                     |
| cfi             | 字符串 | CFI 定位信息（未使用，为 null）             |
| start_offset    | 整数   | 文本起始偏移量（高亮使用）                  |
| end_offset      | 整数   | 文本结束偏移量（高亮使用）                  |
| create_time     | 字符串 | 创建时间（格式：月 / 日 / 年 时：分: 秒）   |

### user_shelf.json（用户书架表）

| 字段名     | 类型   | 描述                                              |
| ---------- | ------ | ------------------------------------------------- |
| id         | 整数   | 书架记录唯一标识                                  |
| user_id    | 整数   | 关联的用户 ID                                     |
| book_id    | 整数   | 关联的书籍 ID                                     |
| added_time | 字符串 | 添加到书架的时间（格式：月 / 日 / 年 时：分: 秒） |

### book.json（书籍表）

| 字段名       | 类型   | 描述                                     |
| ------------ | ------ | ---------------------------------------- |
| id           | 整数   | 书籍唯一标识                             |
| title        | 字符串 | 书籍标题                                 |
| author       | 字符串 | 作者                                     |
| cover        | 字符串 | 封面图片 URL                             |
| category     | 字符串 | 书籍分类                                 |
| intro        | 字符串 | 书籍简介                                 |
| file_path    | 字符串 | 书籍文件存储路径                         |
| file_type    | 字符串 | 文件类型（epub、pdf、txt 等）            |
| is_free      | 整数   | 是否免费（1：免费）                      |
| publisher    | 字符串 | 出版社                                   |
| publish_time | 字符串 | 出版时间（格式：月 / 日 / 年）           |
| isbn         | 字符串 | 国际标准书号                             |
| brand        | 字符串 | 品牌方                                   |
| uploader_id  | 整数   | 上传者 ID（null 表示系统默认）           |
| visibility   | 字符串 | 可见性（PENDING：待审核，private：私有） |

###  user.json（用户表）

| 字段名      | 类型   | 描述                                          |
| ----------- | ------ | --------------------------------------------- |
| id          | 整数   | 用户唯一标识                                  |
| phone       | 字符串 | 手机号（登录账号）                            |
| password    | 字符串 | 密码（加密存储）                              |
| nickname    | 字符串 | 用户昵称                                      |
| create_time | 字符串 | 账号创建时间（格式：日 / 月 / 年 时：分: 秒） |

## 启动

请将后端项目导入IDEA,前端项目导入vs code,启动后端项目，打开后端端口http://localhost/8080，数据库表导入Navicat里， 在vscode终端页面输入npm run dev,打开端口http://localhost/5173，即可开始项目。